<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat Dashboard</title>
  <style>
    /* your existing styles here */
  </style>
</head>
<body>
  <div id="conversations">
    <h2>Conversations</h2>
    <ul id="convoList"></ul>
  </div>
  <div id="chat">
    <h2>Chat</h2>
    <div id="messages">Select a conversation...</div>
    <form id="messageForm">
      <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" required />
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const API_BASE = 'https://chat-backend.rsmilga08.workers.dev';

    const username = sessionStorage.getItem('username');
    const userId = parseInt(sessionStorage.getItem('user_id'));
    if (!username || !userId) {
      location.href = 'index.html';
    }

    let currentConvoId = null;

    // Load conversations for logged-in user
    fetch(`${API_BASE}/getConversations`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      mode: 'cors',
      credentials: 'omit',
      body: JSON.stringify({ user_id: userId })
    })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
      return r.json();
    })
    .then(data => {
      if (data.error) {
        alert('Error fetching conversations: ' + data.error);
        return;
      }
      const list = document.getElementById('convoList');
      list.innerHTML = '';
      if (data.conversations.length === 0) {
        list.textContent = "No conversations found.";
        return;
      }
      data.conversations.forEach(c => {
        const li = document.createElement('li');
        li.textContent = 'Chat with ' + c.other_username;
        li.style.cursor = 'pointer';
        li.onclick = () => loadMessages(c.convo_id);
        list.appendChild(li);
      });
    })
    .catch(err => {
      alert('Failed to load conversations: ' + err.message);
      console.error(err);
    });

    function loadMessages(convoId, showLoading = true) {
      currentConvoId = convoId;
      const mdiv = document.getElementById('messages');
      
      if (showLoading) {
        mdiv.textContent = 'Loading messages...';
      }

      fetch(`${API_BASE}/getMessages`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        mode: 'cors',
        credentials: 'omit',
        body: JSON.stringify({ convo_id: convoId })
      })
      .then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
      })
      .then(data => {
        if (data.error) {
          alert('Error fetching messages: ' + data.error);
          return;
        }
        mdiv.innerHTML = '';
        if (data.messages.length === 0) {
          mdiv.textContent = 'No messages yet.';
          return;
        }

        data.messages.forEach(msg => {
          const d = document.createElement('div');
          d.className = 'msg ' + (msg.user_id === userId ? 'you' : 'other');
          d.textContent = msg.retracted ? 'retracted' : msg.message;

          const ts = document.createElement('div');
          ts.className = 'timestamp';
          ts.textContent = new Date(msg.timestamp).toLocaleString();
          d.appendChild(ts);

          d.onclick = () => {
            d.classList.toggle('show-ts');
            const existingBtn = d.querySelector('.retract-btn');
            if (existingBtn) existingBtn.remove();

            if (msg.retracted && d.classList.contains('show-ts')) {
              const origMsgDiv = document.createElement('div');
              origMsgDiv.style.fontStyle = 'italic';
              origMsgDiv.style.marginTop = '4px';
              origMsgDiv.textContent = msg.message;
              d.appendChild(origMsgDiv);
            }

            if (msg.user_id === userId && d.classList.contains('show-ts')) {
              const btn = document.createElement('span');
              btn.className = 'retract-btn';
              btn.textContent = msg.retracted ? 'Unretract' : 'Retract';
              btn.onclick = (ev) => {
                ev.stopPropagation();
                toggleRetract(msg.message_id, msg.retracted, d, msg.message, btn);
              };
              d.appendChild(btn);
            }
          };

          mdiv.appendChild(d);
        });

        mdiv.scrollTop = mdiv.scrollHeight;
      })
      .catch(err => {
        alert('Failed to load messages: ' + err.message);
        console.error(err);
      });
    }

    function toggleRetract(message_id, currentFlag, messageDiv, originalMessage, button) {
      fetch(`${API_BASE}/toggleRetract`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        mode: 'cors',
        credentials: 'omit',
        body: JSON.stringify({ message_id, retracted: currentFlag })
      })
      .then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
      })
      .then(res => {
        if (res.success) {
          const ts = messageDiv.querySelector('.timestamp');
          messageDiv.textContent = res.newFlag ? 'retracted' : originalMessage;
          messageDiv.appendChild(ts);

          if (res.newFlag) {
            const origMsgDiv = document.createElement('div');
            origMsgDiv.style.fontStyle = 'italic';
            origMsgDiv.style.marginTop = '4px';
            origMsgDiv.textContent = originalMessage;
            messageDiv.appendChild(origMsgDiv);
          }

          button.textContent = res.newFlag ? 'Unretract' : 'Retract';
          currentFlag = res.newFlag;
        } else {
          alert('Failed to update message status');
        }
      })
      .catch(err => {
        alert('Error updating message: ' + err.message);
        console.error(err);
      });
    }

    document.getElementById('messageForm').addEventListener('submit', e => {
      e.preventDefault();
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !currentConvoId) return;

      fetch(`${API_BASE}/sendMessage`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        mode: 'cors',
        credentials: 'omit',
        body: JSON.stringify({ convo_id: currentConvoId, user_id: userId, message: text })
      })
      .then(r => {
        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
        return r.json();
      })
      .then(res => {
        if (res.success) {
          input.value = '';
          loadMessages(currentConvoId, false);
        } else {
          alert('Failed to send message');
        }
      })
      .catch(err => {
        alert('Error sending message: ' + err.message);
        console.error(err);
      });
    });
  </script>
</body>
</html>
