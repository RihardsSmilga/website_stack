<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
      background-color: white;
      color: black;
    }

    #conversations {
      width: 25%;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding: 20px;
    }

    #chat {
      width: 75%;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }

    #messages {
      flex-grow: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .msg {
      margin: 5px 0;
      padding: 5px 10px;
      max-width: 60%;
      word-wrap: break-word;
      border-radius: 6px;
      position: relative;
      user-select: none;
      white-space: pre-wrap;
    }

    .you {
      align-self: flex-end;
      text-align: right;
      background-color: #eee;
    }

    .other {
      align-self: flex-start;
      text-align: left;
      background-color: #ddd;
    }

    .msg:hover {
      cursor: pointer;
      background-color: #f0f0f0;
    }

    .timestamp {
      font-size: 0.75em;
      color: #555;
      margin-top: 4px;
      display: none;
    }

    .msg.show-ts .timestamp {
      display: block;
    }

    .orig-msg {
      font-style: italic;
      margin-top: 4px;
      white-space: pre-wrap;
    }

    .retract-btn {
      margin-left: 8px;
      font-size: 0.75em;
      cursor: pointer;
      color: blue;
      text-decoration: underline;
      user-select: none;
      display: inline-block;
      margin-top: 4px;
    }

    #messageForm {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #messageInput {
      flex-grow: 1;
      padding: 8px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #messageForm button {
      padding: 8px 16px;
      font-size: 1em;
      border: none;
      border-radius: 4px;
      background-color: #333;
      color: white;
      cursor: pointer;
    }

    #messageForm button:hover {
      background-color: #555;
    }

    /* Error/message display below Conversations header */
    #convoError {
      color: black;
      margin-top: 10px;
      font-weight: normal;
    }
  </style>
</head>
<body>
  <div id="conversations">
    <h2>Conversations</h2>
    <div id="convoError"></div>
    <ul id="convoList"></ul>
  </div>
  <div id="chat">
    <h2>Chat</h2>
    <div id="messages">Select a conversation...</div>
    <form id="messageForm">
      <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" required />
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const username = sessionStorage.getItem('username');
    const userIdRaw = sessionStorage.getItem('user_id');
    const userId = userIdRaw ? parseInt(userIdRaw) : null;

    if (!username || !userId) {
      location.href = 'index.html';
    }

    let currentConvoId = null;

    const API_BASE = ''; // Adjust if needed

    // Load conversations for logged-in user
    function loadConversations() {
      const convoErrorDiv = document.getElementById('convoError');
      const convoList = document.getElementById('convoList');
      convoErrorDiv.textContent = 'chat-backend.rsmilga08.workers.dev';
      convoList.innerHTML = 'Loading...';

      fetch(API_BASE + '/getConversations', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: userId })
      })
      .then(r => r.text())
      .then(text => {
        try {
          const data = JSON.parse(text);
          console.log('Conversations API response:', data);
          convoList.innerHTML = '';

          if (data.error) {
            convoErrorDiv.textContent = 'Error fetching conversations: ' + data.error;
            return;
          }
          if (!data.conversations || data.conversations.length === 0) {
            convoErrorDiv.textContent = 'No conversations found.';
            return;
          }

          data.conversations.forEach(c => {
            const li = document.createElement('li');
            li.textContent = 'Chat with ' + (c.other_username || 'Unknown');
            li.style.cursor = 'pointer';
            li.onclick = () => loadMessages(c.convo_id);
            convoList.appendChild(li);
          });
        } catch(e) {
          convoErrorDiv.textContent = 'Failed to parse conversations response.';
          console.error('Parsing error:', e, 'Response text:', text);
          convoList.innerHTML = '';
        }
      })
      .catch(err => {
        convoErrorDiv.textContent = 'Failed to load conversations.';
        console.error('Fetch error:', err);
        convoList.innerHTML = '';
      });
    }

    loadConversations();

    // Load messages for selected conversation
    function loadMessages(convoId, showLoading = true) {
      currentConvoId = convoId;
      const mdiv = document.getElementById('messages');

      if (showLoading) {
        mdiv.textContent = 'Loading messages...';
      }

      fetch(API_BASE + '/getMessages', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ convo_id: convoId })
      })
      .then(r => r.json())
      .then(data => {
        if (data.error) {
          alert('Error fetching messages: ' + data.error);
          return;
        }
        mdiv.innerHTML = '';
        if (data.messages.length === 0) {
          mdiv.textContent = 'No messages yet.';
          return;
        }

        data.messages.forEach(msg => {
          const d = document.createElement('div');
          d.className = 'msg ' + (msg.user_id === userId ? 'you' : 'other');

          d.textContent = msg.retracted ? 'retracted' : msg.message;

          const ts = document.createElement('div');
          ts.className = 'timestamp';
          ts.textContent = new Date(msg.timestamp).toLocaleString();
          d.appendChild(ts);

          d.onclick = () => {
            d.classList.toggle('show-ts');

            // Remove existing original message div or retract button if any
            const existingOrig = d.querySelector('.orig-msg');
            if (existingOrig) existingOrig.remove();

            const existingBtn = d.querySelector('.retract-btn');
            if (existingBtn) existingBtn.remove();

            if (msg.retracted && d.classList.contains('show-ts')) {
              const origMsgDiv = document.createElement('div');
              origMsgDiv.className = 'orig-msg';
              origMsgDiv.textContent = msg.message;
              d.appendChild(origMsgDiv);
            }

            if (msg.user_id === userId && d.classList.contains('show-ts')) {
              const btn = document.createElement('span');
              btn.className = 'retract-btn';
              btn.textContent = msg.retracted ? 'Unretract' : 'Retract';
              btn.onclick = ev => {
                ev.stopPropagation();
                toggleRetract(msg.message_id, msg.retracted, d, msg.message, btn);
              };
              d.appendChild(btn);
            }
          };

          mdiv.appendChild(d);
        });

        mdiv.scrollTop = mdiv.scrollHeight;
      })
      .catch(err => {
        alert('Failed to load messages');
        console.error(err);
      });
    }

    // Toggle retract/unretract message
    function toggleRetract(message_id, currentFlag, messageDiv, originalMessage, button) {
      fetch(API_BASE + '/toggleRetract', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ message_id, retracted: currentFlag })
      })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          // Update message text
          messageDiv.textContent = res.newFlag ? 'retracted' : originalMessage;

          const ts = document.createElement('div');
          ts.className = 'timestamp';
          ts.textContent = new Date().toLocaleString();
          messageDiv.appendChild(ts);

          // Remove old original msg div if any
          const existingOrig = messageDiv.querySelector('.orig-msg');
          if (existingOrig) existingOrig.remove();

          // If retracted and message is showing timestamp, show original message italicized
          if (res.newFlag && messageDiv.classList.contains('show-ts')) {
            const origMsgDiv = document.createElement('div');
            origMsgDiv.className = 'orig-msg';
            origMsgDiv.textContent = originalMessage;
            messageDiv.appendChild(origMsgDiv);
          }

          // Update button text
          button.textContent = res.newFlag ? 'Unretract' : 'Retract';

          // Update the internal retracted flag for future toggles
          // This is important to keep button toggling correctly
          // We'll store it in button.dataset
          button.dataset.retracted = res.newFlag ? 'true' : 'false';
          // Also update msg.retracted for the message div (closure issue workaround)
          // This only affects next toggle since msg is immutable here
        } else {
          alert('Failed to update message status');
        }
      })
      .catch(err => {
        alert('Error updating message');
        console.error(err);
      });
    }

    // Handle sending new message
    document.getElementById('messageForm').addEventListener('submit', e => {
      e.preventDefault();
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || !currentConvoId) return;

      fetch(API_BASE + '/sendMessage', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ convo_id: currentConvoId, user_id: userId, message: text })
      })
      .then(r => r.json())
      .then(res => {
        if (res.success) {
          input.value = '';
          loadMessages(currentConvoId, false);
        } else {
          alert('Failed to send message');
        }
      })
      .catch(err => {
        alert('Error sending message');
        console.error(err);
      });
    });
  </script>
</body>
</html>
